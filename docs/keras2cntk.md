# Keras "inception_v3" to CNTK conversion example

Model: ["inception_v3" for imagenet](https://github.com/fchollet/deep-learning-models)
Source: Keras
Destination: CNTK

0. Install [Keras](https://keras.io/#installation) and [CNTK](https://docs.microsoft.com/en-us/cognitive-toolkit/Setup-CNTK-on-your-machine) in case

```bash
pip install keras

pip install https://cntk.ai/PythonWheel/CPU-Only/cntk-2.4-cp27-cp27mu-linux_x86_64.whl
or
pip install https://cntk.ai/PythonWheel/CPU-Only/cntk-2.4-cp35-cp35m-linux_x86_64.whl
```

1. Prepare the Keras model.
You need to prepare your pre-trained keras model firstly. And there is a pre-trained model extractor for frameworks to help you. You can refer it to extract your Keras model structure and weights.

```bash
$ python -m mmdnn.conversion._script.extractModel -f keras -n inception_v3

Keras model inception_v3 is saved in [./imagenet_inception_v3.h5]
```

The you got the Keras pre-trained inception_v3 model which is downloaded to current working directory.

2. Convert the pre-trained model files to intermediate representation

```bash
$ python -m mmdnn.conversion._script.convertToIR -f keras -d converted -w imagenet_inception_v3.h5

Using TensorFlow backend.
.
.
.
IR network structure is saved as [converted.json].
IR network structure is saved as [converted.pb].
IR weights are saved as [converted.npy].
```

Then you got the **intermediate representation** files *converted.json* for visualization, *converted.proto* and *converted.npy* for next steps.


3. Convert the IR files to CNTK models

```bash
$ python -m mmdnn.conversion._script.IRToCode -f cntk -d converted_cntk.py -n converted.pb -w converted.npy

Parse file [converted.pb] with binary format successfully.
Target network code snippet is saved as [converted_cntk.py].
```

And you will get a filename *converted_cntk.py*, which contains the **original CNTK** codes to build the *Inception V3* network.

With the three steps, you have already converted the pre-trained Keras Inception_v3 models to CNTK network file *converted_cntk.py* and weight file *converted.npy*. You can use these two files to fine-tune training or inference.

4. Dump the original CNTK model

```bash
$ python -m mmdnn.conversion.examples.cntk.imagenet_test -n converted_cntk -w converted.npy --dump cntk_inception_v3.dnn
.
.
.
CNTK model file is saved as [cntk_inception_v3.dnn], generated by [converted_cntk.py] and [converted.npy].
```
The file *cntk_inception_v3.dnn* can be loaded by CNTK directly.